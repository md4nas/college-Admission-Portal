<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::Layout(~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>Fee Payment Portal</title>
</head>
<body>

<section>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-gradient-primary text-white">
                    <div class="card-body text-center py-4">
                        <i class='bx bx-credit-card' style="font-size: 3rem;"></i>
                        <h2 class="mt-3 mb-2">Fee Payment Portal</h2>
                        <p class="mb-0">Complete your admission by paying the required fees</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- College Bank Details -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-info">
                    <div class="card-header bg-info text-white">
                        <h5><i class='bx bx-bank me-2'></i>College Bank Account Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>Account Name:</strong> ABC Engineering College
                                </div>
                                <div class="mb-3">
                                    <strong>Account Number:</strong> <span class="text-primary fw-bold">1234567890123456</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Bank Name:</strong> State Bank of India
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <strong>IFSC Code:</strong> <span class="text-primary fw-bold">SBIN0001234</span>
                                </div>
                                <div class="mb-3">
                                    <strong>Branch:</strong> Main Campus Branch
                                </div>
                                <div class="mb-3">
                                    <strong>UPI ID:</strong> <span class="text-primary fw-bold">abcengineering@sbi</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Important Notice -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info border-0 shadow-sm">
                    <div class="d-flex align-items-center">
                        <i class='bx bx-info-circle fs-3 text-info me-3'></i>
                        <div>
                            <h6 class="alert-heading mb-1">Payment Instructions</h6>
                            <p class="mb-0 small">Ensure your seat is accepted and all details are correct before proceeding with payment. Fee payment deadline is 30 days from admission confirmation.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Fee Calculator -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class='bx bx-calculator me-2'></i>Fee Calculator</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Course <span class="text-danger">*</span></label>
                                <select class="form-select" id="courseSelect" onchange="updateBranches()">
                                    <option value="">Choose Course</option>
                                    <option value="btech">B.Tech (4 Years)</option>
                                    <option value="bsc">B.Sc (3 Years)</option>
                                    <option value="bca">BCA (3 Years)</option>
                                    <option value="mtech">M.Tech (2 Years)</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Select Branch <span class="text-danger">*</span></label>
                                <select class="form-select" id="branchSelect" onchange="calculateFee()">
                                    <option value="">Choose Branch</option>
                                </select>
                            </div>
                        </div>

                        <!-- Fee Breakdown -->
                        <div id="feeBreakdown" class="row g-3" style="display: none;">
                            <div class="col-12">
                                <div class="card border-info shadow-sm">
                                    <div class="card-body">
                                        <h6 class="card-title text-primary mb-4">Fee Breakdown (Per Year)</h6>
                                        <div class="table-responsive">
                                            <table class="table table-borderless">
                                                <tbody>
                                                <tr>
                                                    <td class="w-75">Tuition Fee</td>
                                                    <td class="w-25 text-end fw-medium" id="tuitionFee">₹0</td>
                                                </tr>
                                                <tr>
                                                    <td>Development Fee</td>
                                                    <td class="text-end fw-medium" id="developmentFee">₹0</td>
                                                </tr>
                                                <tr>
                                                    <td>Lab Fee</td>
                                                    <td class="text-end fw-medium" id="labFee">₹0</td>
                                                </tr>
                                                <tr>
                                                    <td>Library Fee</td>
                                                    <td class="text-end fw-medium" id="libraryFee">₹0</td>
                                                </tr>
                                                <tr>
                                                    <td>Exam Fee</td>
                                                    <td class="text-end fw-medium" id="examFee">₹0</td>
                                                </tr>
                                                <tr class="border-top">
                                                    <td class="pt-3 fw-bold">Total Amount</td>
                                                    <td class="pt-3 text-end fw-bold text-primary" id="totalAmount">₹0</td>
                                                </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fee Payment Center -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-gradient-warning border-0">
                        <h5 class="mb-0"><i class='bx bx-credit-card me-2'></i>Fee Payment Center</h5>
                    </div>
                    <div class="card-body p-4">
                        <div class="row mb-4">
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class='bx bx-check-shield fs-4 text-primary me-3'></i>
                                    <div>
                                        <small class="text-muted d-block">Application Status</small>
                                        <span class="badge fs-6" th:classappend="${appStatus == 'APPROVED' or appStatus == 'ALLOCATED' or appStatus == 'ACCEPTED' ? 'bg-success' : (appStatus == 'REJECTED' or appStatus == 'DECLINED' ? 'bg-danger' : 'bg-warning')}" th:text="${appStatus}">Status</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class='bx bx-book fs-4 text-info me-3'></i>
                                    <div>
                                        <small class="text-muted d-block">Assigned Course</small>
                                        <span th:if="${appCourse != null and !#strings.isEmpty(appCourse)}" class="badge bg-info fs-6" th:text="${appCourse}">Course</span>
                                        <span th:if="${appCourse == null or #strings.isEmpty(appCourse)}" class="text-muted small">Not yet assigned</span>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4 mb-3">
                                <div class="d-flex align-items-center p-3 bg-light rounded">
                                    <i class='bx bx-buildings fs-4 text-success me-3'></i>
                                    <div>
                                        <small class="text-muted d-block">Allocated Branch</small>
                                        <span th:if="${appAllocatedBranch != null and !#strings.isEmpty(appAllocatedBranch)}" class="badge bg-success fs-6" th:text="${appAllocatedBranch}">Branch</span>
                                        <span th:if="${appAllocatedBranch == null or #strings.isEmpty(appAllocatedBranch)}" class="text-muted small">Not yet allocated</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-8">
                                <div class="alert alert-warning border-0 mb-0">
                                    <h6 class="alert-heading"><i class='bx bx-error-circle me-2'></i>Before You Pay</h6>
                                    <ul class="mb-0 small">
                                        <li>Calculate fees using the calculator above</li>
                                        <li>Keep your transaction receipt safe</li>
                                        <li>Payment verification takes 2-3 working days</li>
                                        <li>Contact support if payment fails</li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card border-success shadow-sm">
                                    <div class="card-body text-center p-4">
                                        <i class='bx bx-wallet text-success mb-2' style="font-size: 2.5rem;"></i>
                                        <h6 class="text-muted mb-1">Total Fee Amount</h6>
                                        <h2 id="totalFeeAmount" class="text-warning mb-3 fw-bold">₹0</h2>
                                        <button type="button" id="payNowBtn" class="btn btn-success btn-lg w-100 shadow-sm" onclick="handlePayNowClick()" disabled>
                                            <i class='bx bx-credit-card me-2'></i>Proceed to Pay
                                        </button>
                                        <small id="feeStatusMessage" class="text-muted mt-2 d-block">Fee calculation pending</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Options -->
        <div id="paymentOptionsSection" class="row mb-4" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class='bx bx-credit-card me-2'></i>Payment Options</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <!-- UPI Payment -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-info payment-option" onclick="selectPaymentMethod('upi')">
                                    <div class="card-body text-center">
                                        <i class='bx bx-mobile text-primary' style="font-size: 3rem;"></i>
                                        <h6 class="mt-2">UPI Payment</h6>
                                        <p class="text-muted small">Pay using UPI apps like PhonePe, GPay, Paytm</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Bank Transfer -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-success payment-option" onclick="selectPaymentMethod('bank')">
                                    <div class="card-body text-center">
                                        <i class='bx bxs-bank text-success' style="font-size: 3rem;"></i>
                                        <h6 class="mt-2">Bank Transfer</h6>
                                        <p class="text-muted small">Transfer to college bank account</p>
                                    </div>
                                </div>
                            </div>
                            <!-- Upload Receipt -->
                            <div class="col-md-4 mb-3">
                                <div class="card border-info payment-option" onclick="selectPaymentMethod('receipt')">
                                    <div class="card-body text-center">
                                        <i class='bx bx-receipt text-info' style="font-size: 3rem;"></i>
                                        <h6 class="mt-2">Upload Receipt</h6>
                                        <p class="text-muted small">Upload payment receipt for verification</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Payment Form -->
        <div id="paymentFormSection" class="row mb-4" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class='bx bx-form me-2'></i>Payment Submission</h5>
                    </div>
                    <div class="card-body">
                        <form id="paymentForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Student Name</label>
                                        <input type="text" class="form-control" th:value="${user.fullName}" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Course & Branch</label>
                                        <input type="text" class="form-control" id="courseInfo" readonly>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Amount Paid <span class="text-danger">*</span></label>
                                        <input type="number" class="form-control" id="amountPaid" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Payment Method</label>
                                        <input type="text" class="form-control" id="paymentMethodDisplay" readonly>
                                    </div>
                                    <div class="mb-3" id="transactionField">
                                        <label class="form-label">Transaction ID/Reference Number <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="transactionId" required>
                                    </div>
                                    <div class="mb-3" id="receiptField">
                                        <label class="form-label">Upload Payment Receipt (Optional)</label>
                                        <input type="file" class="form-control" id="receiptFile" accept=".jpg,.jpeg,.png,.pdf">
                                        <small class="text-muted">Upload receipt for faster verification - JPG, PNG, PDF (Max 5MB)</small>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Additional Notes (Optional)</label>
                                <textarea class="form-control" id="paymentNotes" rows="3" placeholder="Any additional information about the payment"></textarea>
                            </div>
                            <div class="text-center">
                                <button type="submit" class="btn btn-success btn-lg me-3">
                                    <i class='bx bx-check me-2'></i>Submit Payment
                                </button>
                                <button type="button" class="btn btn-secondary btn-lg" onclick="resetPaymentForm()">
                                    <i class='bx bx-refresh me-2'></i>Reset
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>


        <!-- Important Instructions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-white">
                        <h5><i class='bx bx-info-circle me-2'></i>Important Instructions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-primary">Payment Guidelines</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class='bx bx-check text-success me-2'></i>Payment deadline: 30 days from admission</li>
                                    <li class="mb-2"><i class='bx bx-check text-success me-2'></i>Keep payment receipt/transaction ID safe</li>
                                    <li class="mb-2"><i class='bx bx-check text-success me-2'></i>Upload clear images of receipts</li>
                                    <li class="mb-2"><i class='bx bx-check text-success me-2'></i>Payment verification takes 2-3 working days</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-primary">Contact Information</h6>
                                <ul class="list-unstyled">
                                    <li class="mb-2"><i class='bx bx-phone text-info me-2'></i>Phone: +91-98765xxxxx</li>
                                    <li class="mb-2"><i class='bx bx-envelope text-info me-2'></i>Email: fees@abcengineering.edu</li>
                                    <li class="mb-2"><i class='bx bx-time text-info me-2'></i>Office Hours: 9:00 AM - 5:00 PM</li>
                                    <li class="mb-2"><i class='bx bx-map text-info me-2'></i>Accounts Office, Ground Floor</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Navigation -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="/user/" class="btn btn-secondary">
                    <i class='bx bx-arrow-back'></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>

    <style>
        .bg-gradient-primary {
            background: linear-gradient(45deg, #007bff, #0056b3);
        }

        .bg-gradient-warning {
            background: linear-gradient(45deg, #ffc107, #e0a800);
        }

        .payment-option {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .payment-option:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .card {
            transition: transform 0.2s ease-in-out;
        }

        .card:hover {
            transform: translateY(-1px);
        }
    </style>

    <script>
        const feeStructure = {
            btech: {
                'Computer Science': { tuition: 80000, development: 15000, lab: 10000, library: 3000, exam: 2000 },
                'Mechanical': { tuition: 75000, development: 15000, lab: 8000, library: 3000, exam: 2000 },
                'Electrical': { tuition: 75000, development: 15000, lab: 8000, library: 3000, exam: 2000 },
                'Civil': { tuition: 70000, development: 15000, lab: 5000, library: 3000, exam: 2000 },
                'Electronics': { tuition: 78000, development: 15000, lab: 9000, library: 3000, exam: 2000 }
            },
            bsc: {
                'Physics': { tuition: 45000, development: 10000, lab: 8000, library: 2000, exam: 1500 },
                'Chemistry': { tuition: 45000, development: 10000, lab: 10000, library: 2000, exam: 1500 },
                'Mathematics': { tuition: 40000, development: 10000, lab: 3000, library: 2000, exam: 1500 },
                'Biology': { tuition: 48000, development: 10000, lab: 12000, library: 2000, exam: 1500 }
            },
            bca: {
                'Computer Applications': { tuition: 55000, development: 12000, lab: 8000, library: 2500, exam: 1500 }
            },
            mtech: {
                'Computer Science': { tuition: 90000, development: 20000, lab: 15000, library: 4000, exam: 3000 },
                'Mechanical': { tuition: 85000, development: 20000, lab: 12000, library: 4000, exam: 3000 },
                'Electronics': { tuition: 88000, development: 20000, lab: 14000, library: 4000, exam: 3000 }
            }
        };

        const branches = {
            btech: ['Computer Science', 'Mechanical', 'Electrical', 'Civil', 'Electronics'],
            bsc: ['Physics', 'Chemistry', 'Mathematics', 'Biology'],
            bca: ['Computer Applications'],
            mtech: ['Computer Science', 'Mechanical', 'Electronics']
        };

        function updateBranches() {
            const courseSelect = document.getElementById('courseSelect');
            const branchSelect = document.getElementById('branchSelect');
            const selectedCourse = courseSelect.value;

            branchSelect.innerHTML = '<option value="">Choose Branch</option>';

            if (selectedCourse && branches[selectedCourse]) {
                branches[selectedCourse].forEach(branch => {
                    const option = document.createElement('option');
                    option.value = branch;
                    option.textContent = branch;
                    branchSelect.appendChild(option);
                });
            }

            document.getElementById('feeBreakdown').style.display = 'none';
        }

        function calculateFee() {
            const courseSelect = document.getElementById('courseSelect');
            const branchSelect = document.getElementById('branchSelect');
            const selectedCourse = courseSelect.value;
            const selectedBranch = branchSelect.value;

            if (selectedCourse && selectedBranch && feeStructure[selectedCourse] && feeStructure[selectedCourse][selectedBranch]) {
                const fees = feeStructure[selectedCourse][selectedBranch];
                const total = fees.tuition + fees.development + fees.lab + fees.library + fees.exam;

                document.getElementById('tuitionFee').textContent = '₹' + fees.tuition.toLocaleString();
                document.getElementById('developmentFee').textContent = '₹' + fees.development.toLocaleString();
                document.getElementById('labFee').textContent = '₹' + fees.lab.toLocaleString();
                document.getElementById('libraryFee').textContent = '₹' + fees.library.toLocaleString();
                document.getElementById('examFee').textContent = '₹' + fees.exam.toLocaleString();
                document.getElementById('totalAmount').textContent = '₹' + total.toLocaleString();
                document.getElementById('feeBreakdown').style.display = 'block';
            }
        }

        function showPaymentOptions() {
            document.getElementById('paymentOptionsSection').style.display = 'block';
            document.getElementById('paymentOptionsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function handlePayNowClick() {
            document.getElementById('paymentOptionsSection').style.display = 'block';
            document.getElementById('paymentOptionsSection').scrollIntoView({ behavior: 'smooth' });
        }

        function selectPaymentMethod(method) {
            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('border-primary', 'bg-light');
            });

            event.currentTarget.classList.add('border-primary', 'bg-light');

            const courseSelect = document.getElementById('courseSelect');
            const branchSelect = document.getElementById('branchSelect');

            let courseInfo = 'Manual Selection';
            if (courseSelect.selectedIndex > 0 && branchSelect.value) {
                courseInfo = courseSelect.options[courseSelect.selectedIndex].text + ' - ' + branchSelect.value;
            }

            document.getElementById('courseInfo').value = courseInfo;

            let methodText = '';
            switch(method) {
                case 'upi': methodText = 'UPI Payment'; break;
                case 'bank': methodText = 'Bank Transfer'; break;
                case 'receipt': methodText = 'Upload Receipt'; break;
            }
            document.getElementById('paymentMethodDisplay').value = methodText;

            // Get the calculated amount from the payment center
            const totalFeeText = document.getElementById('totalFeeAmount').textContent;
            const amount = totalFeeText.replace('₹', '').replace(/,/g, '');
            document.getElementById('amountPaid').value = amount;
            document.getElementById('amountPaid').readOnly = true;

            document.getElementById('paymentFormSection').style.display = 'block';
            document.getElementById('paymentFormSection').scrollIntoView({ behavior: 'smooth' });
        }

        function resetPaymentForm() {
            document.getElementById('paymentForm').reset();
            document.getElementById('paymentOptionsSection').style.display = 'none';
            document.getElementById('paymentFormSection').style.display = 'none';

            document.querySelectorAll('.payment-option').forEach(option => {
                option.classList.remove('border-primary', 'bg-light');
            });
        }

        document.addEventListener('DOMContentLoaded', function() {
            const appStatus = '[[${appStatus}]]';
            const appCourse = '[[${appCourse}]]';
            const appAllocatedBranch = '[[${appAllocatedBranch}]]';
            const seatAccepted = [[${appSeatAccepted != null and appSeatAccepted}]];

            console.log('Payment page loaded with:', { appStatus, appCourse, appAllocatedBranch, seatAccepted });

            const totalFeeElement = document.getElementById('totalFeeAmount');
            const payNowBtn = document.getElementById('payNowBtn');
            const statusMessage = document.getElementById('feeStatusMessage');

            // Check if user has course and branch allocated
            const hasRequiredData = appCourse && appCourse.trim() !== '' && appAllocatedBranch && appAllocatedBranch.trim() !== '';
            
            if (hasRequiredData) {
                const courseMapping = {
                    'BTECH': 'btech',
                    'BSC': 'bsc', 
                    'BCA': 'bca',
                    'MTECH': 'mtech'
                };

                const branchMapping = {
                    'CSE': 'Computer Science',
                    'ECE': 'Electronics', 
                    'MECHANICAL': 'Mechanical',
                    'CIVIL': 'Civil',
                    'Computer Science': 'Computer Science',
                    'Electronics': 'Electronics',
                    'Mechanical': 'Mechanical', 
                    'Civil': 'Civil',
                    'Physics': 'Physics',
                    'Chemistry': 'Chemistry',
                    'Mathematics': 'Mathematics',
                    'Biology': 'Biology',
                    'Computer Applications': 'Computer Applications'
                };

                const courseKey = courseMapping[appCourse];
                const branchKey = branchMapping[appAllocatedBranch] || appAllocatedBranch;

                console.log('Mapped keys:', { courseKey, branchKey });

                if (courseKey && feeStructure[courseKey] && feeStructure[courseKey][branchKey]) {
                    const fees = feeStructure[courseKey][branchKey];
                    const totalAmount = fees.tuition + fees.development + fees.lab + fees.library + fees.exam;

                    totalFeeElement.textContent = '₹' + totalAmount.toLocaleString();
                    totalFeeElement.className = 'text-success mb-3 fw-bold';
                    payNowBtn.disabled = false;
                    payNowBtn.className = 'btn btn-success btn-lg w-100 shadow-sm';
                    statusMessage.textContent = 'Ready for payment';
                    statusMessage.className = 'text-success mt-2 d-block small';
                    
                    console.log('Fee calculated:', totalAmount);
                } else {
                    statusMessage.textContent = 'Fee structure not found for your course/branch';
                    statusMessage.className = 'text-warning mt-2 d-block small';
                    console.log('Fee structure not found for:', courseKey, branchKey);
                }
            } else {
                if (!appCourse || appCourse.trim() === '') {
                    statusMessage.textContent = 'Course not yet assigned';
                } else if (!appAllocatedBranch || appAllocatedBranch.trim() === '') {
                    statusMessage.textContent = 'Branch not yet allocated';
                } else {
                    statusMessage.textContent = 'Fee calculation pending';
                }
                statusMessage.className = 'text-muted mt-2 d-block small';
                console.log('Missing required data for fee calculation');
            }
        });

        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            e.preventDefault();
            alert('Payment submission successful! Your payment will be verified within 2-3 working days.');
            resetPaymentForm();
        });
    </script>
</section>

</body>
</html>