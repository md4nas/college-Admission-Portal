<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      th:replace="~{base::Layout(~{::section})}">
<head>
    <meta charset="UTF-8">
    <title>Application Status</title>
</head>
<body>

<section>
    <div class="container-fluid">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card bg-info text-white">
                    <div class="card-body text-center py-4">
                        <i class='bx bx-file-blank' style="font-size: 3rem;"></i>
                        <h2 class="mt-3 mb-2">Application Status</h2>
                        <p class="mb-0">View your submitted college application details</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notice Message -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-info">
                    <h5 class="alert-heading"><i class='bx bx-info-circle me-2'></i>Important Notice</h5>
                    <p class="mb-2">Please review all your submitted information carefully. If you find any errors in your application details or need to make corrections, please contact the administration immediately.</p>
                    <hr>
                    <p class="mb-0"><strong>Contact:</strong> admin@college.edu | Phone: +91-XXXXXXXXXX | Office Hours: 9:00 AM - 5:00 PM</p>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        <div th:if="${session.msg}" th:class="'alert alert-' + ${session.msgType}" class="alert alert-dismissible fade show">
            <span th:text="${session.msg}"></span>
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>

        <!-- Application Details -->
        <div th:if="${application != null}">
            <!-- Final Decision Section (Only when ALLOCATED) -->
            <div th:if="${appStatus == 'ALLOCATED'}" class="row mb-4">
                <div class="col-md-4">
                    <div class="card border-warning">
                        <div class="card-header bg-warning text-dark">
                            <h5 class="mb-0"><i class='bx bx-exclamation-triangle me-2'></i>Final Decision Required</h5>
                        </div>
                        <div class="card-body text-center">
                            <h6 class="text-warning mb-3">Do you want to accept the seat?</h6>
                            <p class="small mb-3">
                                Based on allocated course: <strong th:text="${appCourse}">Course</strong><br>
                                <span th:if="${appAllocatedBranch != null and !#strings.isEmpty(appAllocatedBranch)}">
                                    And branch: <strong th:text="${appAllocatedBranch}">Branch</strong>
                                </span>
                            </p>
                            <div class="d-grid gap-2">
                                <form th:action="@{/user/application/accept-seat}" method="post" onsubmit="return confirmSeatAcceptanceAndRedirect()">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <input type="hidden" name="redirectToPayment" value="true" />
                                    <button type="submit" class="btn btn-success btn-sm w-100">
                                        <i class='bx bx-check me-1'></i>Accept Seat
                                    </button>
                                </form>
                                <form th:action="@{/user/application/decline-seat}" method="post">
                                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                                    <button type="submit" class="btn btn-danger btn-sm w-100">
                                        <i class='bx bx-x me-1'></i>Decline Seat
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class='bx bx-info-circle me-2'></i>Application Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <strong>Application Status:</strong> 
                                    <span class="badge fs-6" th:classappend="${appStatus == 'APPROVED' or appStatus == 'ALLOCATED' or appStatus == 'ACCEPTED' ? 'bg-success' : (appStatus == 'REJECTED' or appStatus == 'DECLINED' ? 'bg-danger' : 'bg-warning')}" th:text="${appStatus}">Status</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Assigned Course:</strong> 
                                    <span th:if="${appCourse != null and !#strings.isEmpty(appCourse)}" class="badge bg-info fs-6" th:text="${appCourse}">Course</span>
                                    <span th:if="${appCourse == null or #strings.isEmpty(appCourse)}" class="text-muted">Not yet assigned</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Allocated Branch:</strong> 
                                    <span th:if="${appAllocatedBranch != null and !#strings.isEmpty(appAllocatedBranch)}" class="badge bg-success fs-6" th:text="${appAllocatedBranch}">Branch</span>
                                    <span th:if="${appAllocatedBranch == null or #strings.isEmpty(appAllocatedBranch)}" class="text-muted">Not yet allocated</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>First Choice:</strong> <span th:text="${appBranch1}">Branch1</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Second Choice:</strong> <span th:text="${appBranch2}">Branch2</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Class 12 Percentage:</strong> <span th:text="${appPercentage12} + '%'">Percentage</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Application Summary (When NOT ALLOCATED) -->
            <div th:if="${appStatus != 'ALLOCATED'}" class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-primary text-white">
                            <h5><i class='bx bx-info-circle me-2'></i>Application Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <strong>Application Status:</strong> 
                                    <span class="badge fs-6" th:classappend="${appStatus == 'APPROVED' or appStatus == 'ALLOCATED' or appStatus == 'ACCEPTED' ? 'bg-success' : (appStatus == 'REJECTED' or appStatus == 'DECLINED' ? 'bg-danger' : 'bg-warning')}" th:text="${appStatus}">Status</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Assigned Course:</strong> 
                                    <span th:if="${appCourse != null and !#strings.isEmpty(appCourse)}" class="badge bg-info fs-6" th:text="${appCourse}">Course</span>
                                    <span th:if="${appCourse == null or #strings.isEmpty(appCourse)}" class="text-muted">Not yet assigned</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Allocated Branch:</strong> 
                                    <span th:if="${appAllocatedBranch != null and !#strings.isEmpty(appAllocatedBranch)}" class="badge bg-success fs-6" th:text="${appAllocatedBranch}">Branch</span>
                                    <span th:if="${appAllocatedBranch == null or #strings.isEmpty(appAllocatedBranch)}" class="text-muted">Not yet allocated</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>First Choice:</strong> <span th:text="${appBranch1}">Branch1</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Second Choice:</strong> <span th:text="${appBranch2}">Branch2</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Class 12 Percentage:</strong> <span th:text="${appPercentage12} + '%'">Percentage</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Personal Information -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-info text-white">
                            <h5><i class='bx bx-user me-2'></i>Personal Information</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4 mb-3">
                                    <strong>Date of Birth:</strong> <span th:text="${appDob}">DOB</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Gender:</strong> <span th:text="${appGender}">Gender</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Phone:</strong> <span th:text="${appPhone}">Phone</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Parents Name:</strong> <span th:text="${appParentsName}">Parents Name</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Parents Phone:</strong> <span th:text="${appParentsPhoneNo}">Parents Phone</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Religion:</strong> <span th:text="${appReligion ?: 'Not specified'}">Religion</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Caste:</strong> <span th:text="${appCaste ?: 'Not specified'}">Caste</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>City:</strong> <span th:text="${appCity}">City</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>State:</strong> <span th:text="${appState}">State</span>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <strong>Pincode:</strong> <span th:text="${appPincode}">Pincode</span>
                                </div>
                                <div class="col-md-12 mb-3">
                                    <strong>Address:</strong> <span th:text="${appAddress}">Address</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Academic Information -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-success text-white">
                            <h5><i class='bx bx-book me-2'></i>Class 10 Details</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-6"><small><strong>School:</strong> <span th:text="${appSchoolName10}">School</span></small></div>
                                <div class="col-6"><small><strong>Board:</strong> <span th:text="${appBoard10Name}">Board</span></small></div>
                                <div class="col-6"><small><strong>Year:</strong> <span th:text="${appPassing10Year}">Year</span></small></div>
                                <div class="col-6"><small><strong>Roll No:</strong> <span th:text="${appRollNo10}">Roll No</span></small></div>
                                <div class="col-6"><small><strong>Total:</strong> <span th:text="${appTotal10Marks}">Total</span></small></div>
                                <div class="col-6"><small><strong>Obtained:</strong> <span th:text="${appObtain10Marks}">Obtained</span></small></div>
                                <div class="col-12">
                                    <small><strong>Percentage:</strong> <span class="text-dark fw-bold" th:text="${appPercentage10 != null ? appPercentage10 + '%' : 'N/A'}">Percentage</span></small>
                                </div>
                            </div>
                            
                            <hr class="my-2">
                            <h6 class="mb-2 text-dark"><strong>Subject Marks</strong></h6>
                            <div class="row g-2">
                                <div class="col-6"><small><strong>Math:</strong> <span th:text="${appClass10Math}">-</span></small></div>
                                <div class="col-6"><small><strong>Science:</strong> <span th:text="${appClass10Science}">-</span></small></div>
                                <div class="col-6"><small><strong>English:</strong> <span th:text="${appClass10English}">-</span></small></div>
                                <div class="col-6"><small><strong>Hindi:</strong> <span th:text="${appClass10Hindi}">-</span></small></div>
                                <div class="col-12"><small><strong>Social:</strong> <span th:text="${appClass10Social}">-</span></small></div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="card h-100">
                        <div class="card-header bg-warning text-white">
                            <h5><i class='bx bx-book-open me-2'></i>Class 12 Details</h5>
                        </div>
                        <div class="card-body p-3">
                            <div class="row g-2">
                                <div class="col-6"><small><strong>School:</strong> <span th:text="${appSchoolName12}">School</span></small></div>
                                <div class="col-6"><small><strong>Board:</strong> <span th:text="${appBoard12Name}">Board</span></small></div>
                                <div class="col-6"><small><strong>Year:</strong> <span th:text="${appPassing12Year}">Year</span></small></div>
                                <div class="col-6"><small><strong>Roll No:</strong> <span th:text="${appRollNo12}">Roll No</span></small></div>
                                <div class="col-6"><small><strong>Total:</strong> <span th:text="${appTotal12Marks}">Total</span></small></div>
                                <div class="col-6"><small><strong>Obtained:</strong> <span th:text="${appObtain12Marks}">Obtained</span></small></div>
                                <div class="col-12">
                                    <small><strong>Percentage:</strong> <span class="text-dark fw-bold" th:text="${appPercentage12 != null ? appPercentage12 + '%' : 'N/A'}">Percentage</span></small>
                                </div>
                            </div>
                            
                            <hr class="my-2">
                            <h6 class="mb-2 text-dark"><strong>Subject Marks</strong></h6>
                            <div class="row g-2">
                                <div class="col-6"><small><strong>Physics:</strong> <span th:text="${appClass12Physics}">-</span></small></div>
                                <div class="col-6"><small><strong>Chemistry:</strong> <span th:text="${appClass12Chemistry}">-</span></small></div>
                                <div class="col-6"><small><strong>Maths:</strong> <span th:text="${appClass12Maths}">-</span></small></div>
                                <div class="col-6"><small><strong>English:</strong> <span th:text="${appClass12English}">-</span></small></div>
                                <div class="col-12"><small><strong>Optional:</strong> <span th:text="${appClass12Optional}">-</span></small></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Entrance Exam Details -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header bg-dark text-white">
                            <h5><i class='bx bx-trophy me-2'></i>Entrance Exam Details</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3 mb-3">
                                    <strong>Exam Name:</strong> <span th:text="${appEntranceName ?: 'N/A'}">Exam</span>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <strong>Roll Number:</strong> <span th:text="${appEntranceRollNo ?: 'N/A'}">Roll</span>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <strong>Year:</strong> <span th:text="${appEntranceYear ?: 'N/A'}">Year</span>
                                </div>
                                <div class="col-md-3 mb-3">
                                    <strong>Rank:</strong> <span class="text-primary fw-bold" th:text="${appEntranceRank ?: 'N/A'}">Rank</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Seat Allocation Section -->
            <div th:if="${application.allocatedBranch != null}" class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-success">
                        <div class="row align-items-center">
                            <div class="col-md-8">
                                <h5 class="alert-heading mb-2">
                                    <i class='bx bx-trophy me-2'></i>Congratulations! Seat Allocated
                                </h5>
                                <p class="mb-0">
                                    You have been allocated a seat in <strong th:text="${application.allocatedBranch}"></strong> branch.
                                </p>
                            </div>
                            <div class="col-md-4 text-end" th:if="${application.status == 'ALLOCATED'}">
                                <form th:action="@{/user/application/accept-seat}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-success me-2">
                                        <i class='bx bx-check'></i> Accept Seat
                                    </button>
                                </form>
                                <form th:action="@{/user/application/decline-seat}" method="post" class="d-inline">
                                    <button type="submit" class="btn btn-outline-danger">
                                        <i class='bx bx-x'></i> Decline Seat
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Application Case -->
        <div th:if="${application == null}" class="text-center py-5">
            <i class='bx bx-file-plus text-muted' style="font-size: 5rem;"></i>
            <h3 class="mt-4 text-muted">No Application Found</h3>
            <p class="text-muted mb-4">You haven't submitted any college application yet.</p>
            <a href="/user/application" class="btn btn-primary btn-lg">
                <i class='bx bx-plus me-2'></i>Submit New Application
            </a>
        </div>

        <!-- Navigation -->
        <div class="row mt-4">
            <div class="col-12 text-center">
                <a href="/user/" class="btn btn-secondary me-3">
                    <i class='bx bx-arrow-back'></i> Back to Dashboard
                </a>
            </div>
        </div>
    </div>
</section>

<script>
    function confirmSeatAcceptanceAndRedirect() {
        const confirmed = confirm('Submit your fee now to fully book your seat. You will be redirected to the payment page. Do you want to proceed?');
        if (confirmed) {
            // Form will submit and redirect will be handled by backend
            return true;
        }
        return false;
    }
</script>
</body>
</html>